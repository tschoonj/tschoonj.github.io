<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: python-bindings | The Code Dungeon]]></title>
  <link href="http://tschoonj.github.io/blog/categories/python-bindings/atom.xml" rel="self"/>
  <link href="http://tschoonj.github.io/"/>
  <updated>2017-10-03T12:34:36+01:00</updated>
  <id>http://tschoonj.github.io/</id>
  <author>
    <name><![CDATA[Tom Schoonjans]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Conda-forge: creating Windows recipes for Autotools based Python projects]]></title>
    <link href="http://tschoonj.github.io/blog/2017/10/01/conda-forge-creating-windows-compatible-recipes-for-autotools-based-python-projects/"/>
    <updated>2017-10-01T10:44:30+01:00</updated>
    <id>http://tschoonj.github.io/blog/2017/10/01/conda-forge-creating-windows-compatible-recipes-for-autotools-based-python-projects</id>
    <content type="html"><![CDATA[<p>It is probably fair to say that <a href="https://www.anaconda.com/download/">Anaconda</a> has become the most popular Python distribution in scientific circles. This should not come as a surprise as it comes with many features that make it stand out from its competitors:</p>

<ul>
<li>a convenient installer</li>
<li>allows for installing several versions of the Python interpreters side-by-side using environments</li>
<li>has access to the most recent versions of many important (scientific) packages</li>
<li>does not require admin privileges!</li>
</ul>


<p>Though Linux and macOS ship with their own Python interpreters, these are in many cases insufficient for development as access to the latest releases of Python packages is usually not possible with the default package managers (outdated packages only) or using <code>pip</code>, especially when binary extensions are required that depend on non-Python libraries.</p>

<p>With Anaconda, it is quite easy to write and build new recipes for Python and non-Python software packages and upload them to a personal distribution channel. <a href="https://conda-forge.org">Conda-forge</a> makes this even easier: just write the recipe, open a pull request on GitHub, and wait for the continuous-integration buildbots to generate binary packages for Linux (<a href="https://circleci.com">Circle-CI</a>), macOS (<a href="https://travis-ci.org">Travis-CI</a>) and Windows (<a href="https://www.appveyor.com">AppVeyor</a>). After merging the pull request on GitHub, the binary packages will be automatically uploaded to the conda-forge channel, at which point they become available to all Anaconda users by executing the command:</p>

<pre><code class="bash">conda install --channel conda-forge my-package
</code></pre>

<p>This procedure works fine as long as the installation script for the Python package uses distutils or setuptools, as it ensures that all files are installed in the appropriate location and that any binary extensions are compiled with the same compiler that was used to compile the Python interpreter. But what happens when the Python package uses a different buildsystem?</p>

<p>Enters my personal flagship project <a href="https://github.com/tschoonj/xraylib">xraylib</a>, a library providing convenient access to physical databases relevant in the field of X-ray physics. This library consists of a core shared library, written in ANSI-C, and comes with bindings for about a dozen of other languages such as Perl, IDL, Ruby, Lua, Fortran, and of course Python. In fact there are two Python bindings: the first extension module is generated with <a href="http://swig.org">SWIG</a> (deals with scalar arguments) and the second one with <a href="http://cython.org">Cython</a> (deals with NumPy arrays as arguments).
In order to support building the core library as well as the many bindings using a single build and installation system (and thereby ignoring the recommended build systems each of these languages bindings has for binary extensions), I use Autotools, which consists of <a href="http://www.gnu.org/software/autoconf/autoconf.html">Autoconf</a>, <a href="https://www.gnu.org/software/automake/">Automake</a> and <a href="https://www.gnu.org/software/libtool/">Libtool</a>. Libtool is key in this setup, as it enables building both shared libraries (the core C library as well as the Fortran bindings) as well as dynamically loadable plugins (Python, Perl, Lua, Ruby and IDL bindings), in a platform-independent manner! See also <a href="https://tschoonj.github.io/blog/2013/09/04/building-libtool-modules-python-bindings/">this old blogpost</a> if you are interested in reading how I accomplished this for the Python bindings.</p>

<p>A typical autotools project may be built and installed through the following three commands (after unpacking the source tarball):</p>

<pre><code class="bash">./configure
make
make install
</code></pre>

<p>The xraylib configure script figures out where the Python extensions need to be installed in the last command, thereby ensuring they will get picked up by the interpreter without fooling around with the PYTHONPATH environment variable. This works well in a conda recipe on both macOS and Linux, and has led to several people uploading xraylib packages to their personal conda channels for these two platforms.</p>

<p>Windows however is an entirely different beast.</p>

<p>Over the years, many have asked me to come up with providing better Python support for xraylib on Windows, in particular via pip and conda, as the Python binary extensions I provide in my xraylib Windows SDKs do not integrate easily with Python interpreters, in particular due to their dependency on specific NumPy versions.</p>

<!-- more -->


<p>Several major obstacles needed to be addressed before successfully generating xraylib’s Python extensions on Windows with a conda recipe. The AppVeyor buildbots offer only a Windows <code>cmd.exe</code> shell to perform the build, as well as the compilers and linkers that are provided by Visual Studio, Microsoft’s integrated development environment, and of course the Python interpreters.</p>

<p>The first major obstacle one has to overcome when running the three commands on Windows is that it does not come with a Bash compatible shell. This is a big problem since the configure script is in fact a Bash shell script, which also expects several basic UNIX utilities to be present such as cat, rm, mkdir, grep, sed,…, but which are missing.
Secondly, there is the compiler problem. Microsoft has its own development suite Visual Studio, which contains a compiler <code>cl.exe</code> suitable for both C and C++ code as well as a linker <code>link.exe</code>, which links the object code together in an executable or library. This compiler and linker are not supported by Autotools, and there is no way around this (to the best of my knowledge). So we need to use a different compiler, one which plays nicely with Autotools: gcc (MinGW-w64!) or clang, neither of which is present on a Windows system by default.
This brings us immediately to the next problem: the <code>ld.exe</code> linker that is part of MinGW-w64 does not like the import libraries (<code>libs\pythonxy.lib</code>) for the Python DLLs and refuses to link the extensions against these libraries. This is due to the fact that the official Python releases for Windows are compiled with Visual Studio, and that Python really only supports building extensions on this platform using the <code>cl.exe</code> compiler, so they didn’t bother including an <code>ld.exe</code> compatible import library.</p>

<p>Until recently, there was no way to solve any of this. But then <a href="https://github.com/mingwandroid">Ray Donnelly</a> of Continuum Analytics (the company behind Anaconda) generated conda recipes for the MinGW-w64 compilers and toolchain and added them to the default conda channel. For this effort, he relied extensively on his previous work for the <a href="http://www.msys2.org">MSYS2</a> project, which provides Windows users with a Bash shell as well as access to a large number of Unix/Linux utilities as well as software package management through <code>pacman</code>. Fortunately, he also added a conda recipe for the Bash shell, thereby solving my first problem, as I can now launch <code>bash.exe</code> from the Windows cmd.exe that is used by the AppVeyor buildbot.</p>

<p>Now after updating the conda recipe (meta.yaml) with the required build dependencies, the next step was to generate the correct bld.bat file containing the commands necessary to generate the bindings.</p>

<pre><code class="batch https://github.com/conda-forge/xraylib-feedstock/blob/master/recipe/bld.bat">IF "%ARCH%" == "64" (
set GCC_ARCH=x86_64-w64-mingw32
set EXTRA_FLAGS=-DMS_WIN64
) else (
set GCC_ARCH=i686-w64-mingw32
)
bash -lc "ln -s ${LOCALAPPDATA}/Temp /tmp"
bash -lc "curl -L -O https://downloads.sourceforge.net/project/swig/swig/swig-3.0.12/swig-3.0.12.tar.gz &amp;&amp; tar xfz swig-3.0.12.tar.gz &amp;&amp; cd swig-3.0.12 &amp;&amp; ./configure --build=$GCC_ARCH --host=$GCC_ARCH --target=$GCC_ARCH --without-perl5 --without-guile --disable-ccache --prefix=/mingw-w64 &amp;&amp; make &amp;&amp; make install"
bash -lc "gendef ${PREFIX}/python${CONDA_PY}.dll &amp;&amp; dlltool -l libpython${CONDA_PY}.a -d python${CONDA_PY}.def -k -A"
bash -lc "autoreconf -fi &amp;&amp; ./configure --disable-static --build=$GCC_ARCH --host=$GCC_ARCH --target=$GCC_ARCH --enable-python-integration --disable-fortran2003 --enable-python --prefix=`cygpath -u $PREFIX` --bindir=`cygpath -u $LIBRARY_BIN` --libdir=`cygpath -u $LIBRARY_LIB` PYTHON=`which python` SWIG=`which swig` CPPFLAGS=$EXTRA_FLAGS LIBS=-L$PWD"
bash -lc "make"
bash -lc "make install"
bash -lc "mv $PREFIX/Library/usr/bin/libxrl-7.dll $PREFIX/Library/bin/"
bash -lc "rm -r $PREFIX/include/xraylib"
bash -lc "rm -rf $PREFIX/Library/tmp"
bash -lc "rm `cygpath -u $LIBRARY_BIN`/xraylib"
bash -lc "rm `cygpath -u $LIBRARY_LIB`/libxrl.la"
bash -lc "rm `cygpath -u $LIBRARY_LIB`/pkgconfig/libxrl.pc"
bash -lc "rm `cygpath -u $SP_DIR`/*.la"
bash -lc "rm `cygpath -u $SP_DIR`/*.dll.a"
bash -lc "rm `cygpath -u $SP_DIR`/xrayhelp.py*"
bash -lc "rm `cygpath -u $SP_DIR`/xraymessages.py*"
bash -lc "rm -r $PREFIX/share/xraylib"
bash -lc "cd swig-3.0.12 &amp;&amp; make uninstall"
bash -lc "rm -rf /mingw-w64/share/swig"
</code></pre>

<p>Let’s have a closer look at what these lines actually do.</p>

<pre><code class="batch">IF "%ARCH%" == "64" (
set GCC_ARCH=x86_64-w64-mingw32
set EXTRA_FLAGS=-DMS_WIN64
) else (
set GCC_ARCH=i686-w64-mingw32
)
</code></pre>

<p>Set shell variable <code>GCC_ARCH</code> to ensure that the right compiler is invoked for the architecture the Python interpreter was built for. Note the presence of an additional preprocessor flag <code>-DMS_WIN64</code>, necessary to avoid a linker error when <a href="https://stackoverflow.com/questions/2842469/python-undefined-reference-to-imp-py-initmodule4">compiling 64-bit Python plugins on Windows.</a></p>

<pre><code class="batch">bash -lc "ln -s ${LOCALAPPDATA}/Temp /tmp"
</code></pre>

<p>Ensure there’s a /tmp folder. I notice that a lot of the Unix utilities complain when this folder is absent.</p>

<pre><code class="batch">bash -lc "curl -L -O https://downloads.sourceforge.net/project/swig/swig/swig-3.0.12/swig-3.0.12.tar.gz &amp;&amp; tar xfz swig-3.0.12.tar.gz &amp;&amp; cd swig-3.0.12 &amp;&amp; ./configure --build=$GCC_ARCH --host=$GCC_ARCH --target=$GCC_ARCH --without-perl5 --without-guile --disable-ccache --prefix=/mingw-w64 &amp;&amp; make &amp;&amp; make install"
</code></pre>

<p>Download, compile and install swig, which is a hard requirement to compile the bindings, but unfortunately was not added by Ray Donnelly to the conda channel.</p>

<pre><code class="batch">bash -lc "gendef ${PREFIX}/python${CONDA_PY}.dll &amp;&amp; dlltool -l libpython${CONDA_PY}.a -d python${CONDA_PY}.def -k -A"
</code></pre>

<p>Generate a definitions file out of the python dll with gendef and turn it into an import library with dlltool. This will allow our binary plugins to link against the python dll when using the ld linker (problem 3!)</p>

<pre><code class="batch">bash -lc "autoreconf -fi &amp;&amp; ./configure --disable-static --build=$GCC_ARCH --host=$GCC_ARCH --target=$GCC_ARCH --enable-python-integration --disable-fortran2003 --enable-python --prefix=`cygpath -u $PREFIX` --bindir=`cygpath -u $LIBRARY_BIN` --libdir=`cygpath -u $LIBRARY_LIB` PYTHON=`which python` SWIG=`which swig` CPPFLAGS=$EXTRA_FLAGS LIBS=-L$PWD"
</code></pre>

<p>Autoreconf and configure xraylib, while setting the appropriate options. Notice the presence of the <code>cygpath</code> command, which is necessary to convert conda’s environment variables containing Windows style paths to Unix style paths. The last option LIBS=-L$PWD is used to ensure that the linker finds the python import library that was created by the previous command.</p>

<pre><code class="batch">bash -lc "make"
bash -lc "make install"
</code></pre>

<p>Compile and install the bindings</p>

<pre><code class="batch">bash -lc "mv $PREFIX/Library/usr/bin/libxrl-7.dll $PREFIX/Library/bin/"
</code></pre>

<p>Move the xraylib core dll to a folder that is picked up by the PATH variable of an Anaconda installation.</p>

<pre><code class="batch">bash -lc "rm -r $PREFIX/include/xraylib"
bash -lc "rm -rf $PREFIX/Library/tmp"
bash -lc "rm `cygpath -u $LIBRARY_BIN`/xraylib"
bash -lc "rm `cygpath -u $LIBRARY_LIB`/libxrl.la"
bash -lc "rm `cygpath -u $LIBRARY_LIB`/pkgconfig/libxrl.pc"
bash -lc "rm `cygpath -u $SP_DIR`/*.la"
bash -lc "rm `cygpath -u $SP_DIR`/*.dll.a"
bash -lc "rm `cygpath -u $SP_DIR`/xrayhelp.py*"
bash -lc "rm `cygpath -u $SP_DIR`/xraymessages.py*"
bash -lc "rm -r $PREFIX/share/xraylib"
bash -lc "cd swig-3.0.12 &amp;&amp; make uninstall"
bash -lc "rm -rf /mingw-w64/share/swig"
</code></pre>

<p>Cleanup redundant files, to avoid them from being packaged into the conda tarballs that will get uploaded.</p>

<p>It should also be mentioned that <a href="https://github.com/tschoonj/xraylib/commit/dcc2b83004e95064a4f6a5d3ca8727f3819b6bfa">considerable changes</a> were necessary to the configure.ac Autoconf script of xraylib, as well as to some of its auxiliary macros (in the m4 subdirectory). This was mostly to ensure that the Windows style paths as returned by the Python interpreter when querying for installation information, would be turned into Unix style paths using <code>cygpath</code>.</p>

<p>For those interested in more information, please have a look at the <a href="https://github.com/conda-forge/xraylib-feedstock">conda-forge xraylib feedstock repository</a>, as well as the <a href="https://github.com/tschoonj/xraylib">xraylib repository</a> itself.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building libtool modules: Python bindings]]></title>
    <link href="http://tschoonj.github.io/blog/2013/09/04/building-libtool-modules-python-bindings/"/>
    <updated>2013-09-04T10:47:00+01:00</updated>
    <id>http://tschoonj.github.io/blog/2013/09/04/building-libtool-modules-python-bindings</id>
    <content type="html"><![CDATA[<p>One of the software packages (<a href="http://github.com/tschoonj/xraylib">xraylib</a>) I am working on, consists of a C-library with bindings to a number of other languages such as Python, Fortran 2003, IDL, Java, Ruby, Lua and Perl. Apart from IDL and Fortran 2003, the source code for these bindings is generated automatically using <a href="http://www.swig.org">swig</a>, although with considerable language-specific modifications to the swig interface file.</p>

<p>The bindings source code afterwards needs to be compiled into a dynamically loadable library, which will then be loaded at runtime by the program whenever the user needs to use a function or variable from the bindings (actually from the underlying C-library, but exposed through the swig generated bindings).
As a rule, each programming language that supports such dynamically loadable libraries comes with specific instructions on how to generate the libraries from the bindings source code, often using platform independent tools.</p>

<p>However, these tools never seem to integrate well with autoconf and automake and lead to quite complicated Makefile.am files. A considerable more easy approach would consist of relying on libtool&rsquo;s functionality of generating these dynamically loadable libraries (called modules in the libtool documentation).
In this series of posts I will share my experiences on generating bindings to the aforementioned languages using libtool in a relatively clear and easy way. All the code has been tested on Linux and Mac OS X. It may also work on Windows though, provided you install a bash shell with the required tools.</p>

<p>In this first post I will discuss Python extension modules.</p>

<!--more-->


<h2>Checking for python development tools</h2>

<p>If you want to create an autotools based project consisting of a C-library and python bindings, then one of the first things that configure will need to check for is the presence of the python interpreter and the development kit consisting of the python headers and some essential tools.
I accomplished this by adding the following lines into configure.ac</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;configure.ac snippet&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;copy paste into your own configure.ac file&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;check <span class="k">for</span> swig&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;AC_CHECK_PROGS<span class="o">([</span>SWIG<span class="o">]</span>,<span class="o">[</span>swig<span class="o">]</span>,<span class="o">[</span><span class="p">&amp;</span>ldquo<span class="p">;</span>noswig<span class="p">&amp;</span>rdquo<span class="p">;</span><span class="o">])</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;present configure with a <span class="nb">command</span>-line option to disable the python bindings&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;AC_ARG_ENABLE<span class="o">([</span>python<span class="o">]</span>,<span class="o">[</span>AS_HELP_STRING<span class="o">([</span><span class="p">&amp;</span>ndash<span class="p">;</span>disable-python<span class="o">]</span>,<span class="o">[</span>build without the python bindings<span class="o">])]</span>,<span class="o">[</span><span class="nv">enable_python</span><span class="o">=</span><span class="nv">$enableval</span><span class="o">]</span>,<span class="o">[</span><span class="nv">enable_python</span><span class="o">=</span>check<span class="o">])</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;default behavior is to install the python bindings into subfolders of <span class="nv">$prefix</span>&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;however, this may require the user to <span class="nb">set </span>the PYTHONPATH environment variable&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;in order to avoid this, invoke configure with the <span class="p">&amp;</span>ndash<span class="p">;</span><span class="nb">enable</span>-python-integration option&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;AC_ARG_ENABLE<span class="o">([</span>python-integration<span class="o">]</span>,<span class="o">[</span>AS_HELP_STRING<span class="o">([</span><span class="p">&amp;</span>ndash<span class="p">;</span><span class="nb">enable</span>-python-integration<span class="o">]</span>,<span class="o">[</span>install the python bindings in the interpreters site-packages folder<span class="o">])]</span>,<span class="o">[</span><span class="nv">enable_python_integration</span><span class="o">=</span><span class="nv">$enableval</span><span class="o">]</span>,<span class="o">[</span><span class="nv">enable_python_integration</span><span class="o">=</span>check<span class="o">])</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;VALID_PYTHON<span class="o">=</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$SWIG</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xnoswig <span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$enable_python</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="c">#don&amp;rsquo;t even bother when swig is not found</span>
</span><span class='line'>        AC_MSG_ERROR<span class="o">([</span><span class="p">&amp;</span>ndash<span class="p">;</span><span class="nb">enable</span>-python was given as an option but swig was not found on the system<span class="o">])</span>
</span><span class='line'><span class="k">elif</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$SWIG</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xswig <span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$enable_python</span><span class="p">&amp;</span>rdquo<span class="p">;</span> !<span class="o">=</span> xno <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="c">#verify the python installation</span>
</span><span class='line'>        AM_PATH_PYTHON<span class="o">(</span>,<span class="o">[</span><span class="nv">PYTHON_FOUND</span><span class="o">=</span><span class="nb">true</span><span class="o">]</span>,<span class="o">[</span><span class="nv">PYTHON_FOUND</span><span class="o">=</span><span class="nb">false</span><span class="o">])</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$PYTHON_FOUND</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xtrue <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                <span class="nv">PYTHON_CPPFLAGS</span><span class="o">=</span>
</span><span class='line'>                <span class="nv">PYTHON_LDFLAGS</span><span class="o">=</span>
</span><span class='line'>                AX_PYTHON_DEVEL
</span><span class='line'>                <span class="k">if</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$PYTHON</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> x <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                        <span class="k">if</span> <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$enable_python</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                                AC_MSG_ERROR<span class="o">([</span>Incomplete python development package<span class="o">])</span>
</span><span class='line'>                        <span class="k">else</span>
</span><span class='line'>                                AC_MSG_WARN<span class="o">([</span>Incomplete python development package<span class="o">])</span>
</span><span class='line'>                        <span class="k">fi</span>
</span><span class='line'>                        <span class="nv">VALID_PYTHON</span><span class="o">=</span>no
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                        <span class="nv">VALID_PYTHON</span><span class="o">=</span>yes
</span><span class='line'>                <span class="k">fi</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;    <span class="k">fi</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fi&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="nb">test</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>x<span class="nv">$VALID_PYTHON</span><span class="p">&amp;</span>rdquo<span class="p">;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    AC_MSG_NOTICE<span class="o">([</span>Building with Python bindings<span class="o">])</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;if <span class="nb">test</span> <span class="s2">&quot;x$enable_python_integration&quot;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nv">pythondir</span><span class="o">=</span><span class="nv">$PYTHON_SITE_PKG</span>
</span><span class='line'>        <span class="nv">pyexecdir</span><span class="o">=</span><span class="nv">$PYTHON_SITE_PKG_EXEC</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>AC_SUBST<span class="o">(</span>PYTHONDIR,<span class="nv">$pythondir</span><span class="o">)</span>
</span><span class='line'>AC_SUBST<span class="o">(</span>PKGPYTHONDIR,<span class="nv">$pkgpythondir</span><span class="o">)</span>
</span><span class='line'>AC_SUBST<span class="o">(</span>PYEXECDIR,<span class="nv">$pyexecdir</span><span class="o">)</span>
</span><span class='line'>AC_SUBST<span class="o">(</span>PKGPYEXECDIR,<span class="nv">$pkgpyexecdir</span><span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fi&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;AM_CONDITIONAL<span class="o">([</span>ENABLE_PYTHON<span class="o">]</span>,<span class="o">[</span><span class="nb">test </span>x<span class="nv">$VALID_PYTHON</span> <span class="o">=</span> xyes<span class="o">])</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>As can be seen from this snippet, I depend on two m4 macros to obtain the required information: <a href="http://www.gnu.org/software/automake/manual/html_node/Python.html">AM_PATH_PYTHON</a>, which searches for Python interpreter and subsequently sets a number of variables that will be used at installation time, and AX_PYTHON_DEVEL (I am using a heavily modified version of the code found at <a href="http://www.gnu.org/software/autoconf-archive/ax_python_devel.html">autoconf archives</a>), which will check for the required headers and perform a test compilation to make sure everything works.</p>

<h2>Writing the Makefile.am</h2>

<p>The Python way of building and installing extensions relies on the <a href="http://docs.python.org/3.3/distutils/setupscript.html#describing-extension-modules">Distutils package</a>, and is guaranteed to work on all platforms but integrates with difficulty into autotools based installation scripts.
However, recent versions of <a href="http://www.gnu.org/software/automake/manual/html_node/Python.html">automake</a> come with built-in support for installing python source files (and even byte-compile them), and comes with some recommendations on how to build your Python extensions module (possibly linked to a C-library as in our case) using libtool. The following example code is based upon these recommendations but also contains additional Makefile targets that deal with generating the Python extension module source through swig. Let&rsquo;s assume our original C-library is called <code>mytest</code>, and is located in the <code>src</code> subfolder of the source tree. The Python bindings will be built in the <code>python</code> subfolder.</p>

<p>In this example, I followed the Python recommendations with regard to naming the extension module:
<blockquote><p>When an extension module written in C or C++ has an accompanying Python module that provides a higher level (e.g. more object oriented) interface, the C/C++ module has a leading underscore.</p><footer><strong><a href="http://www.python.org/dev/peps/pep-0008/#package-and-module-names">http://www.python.org/dev/peps/pep-0008/#package-and-module-names</a> PEP 8 &ndash; Style Guide for Python Code</strong></footer></blockquote></p>

<p>In this case, the accompanying Python module will be automatically generated by swig, and will be called <code>mytest.py</code>, while the extension module will receive the libtool name <code>_mytest.la</code>. The actual library extension will be platform dependent (.so on Linux/Mac OS X, .dll on Windows).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="err">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;python</span> <span class="err">bindings</span> <span class="err">will</span> <span class="err">only</span> <span class="err">be</span> <span class="err">built</span> <span class="err">if</span> <span class="err">all</span> <span class="err">buildtools</span> <span class="err">are</span> <span class="err">available,</span> <span class="err">hence</span> <span class="err">the</span> <span class="err">following</span> <span class="err">automake</span> <span class="err">conditional&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;if</span> <span class="err">ENABLE_PYTHON&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;our</span> <span class="err">python</span> <span class="err">extension</span> <span class="err">module&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="nv">pyexec_LTLIBRARIES</span> <span class="o">=</span> &lt;em&gt;mytest.la
</span><span class='line'><span class="err">&lt;/em&gt;</span><span class="nv">mytest_la_CFLAGS</span> <span class="o">=</span> <span class="k">$(</span>PYTHON_CFLAGS<span class="k">)</span> -I<span class="k">$(</span>top_srcdir<span class="k">)</span>/include <span class="k">$(</span>PYTHON_CPPFLAGS<span class="k">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;link</span> <span class="err">to</span> <span class="err">the</span> <span class="err">C-library&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;probably</span> <span class="err">on</span> <span class="err">Windows</span> <span class="err">one</span> <span class="err">will</span> <span class="err">need</span> <span class="err">to</span> <span class="err">link</span> <span class="err">against</span> <span class="err">the</span> <span class="err">python</span> <span class="err">dll</span> <span class="err">as</span> <span class="err">well&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="nv">_mytest_la_LIBADD</span> <span class="o">=</span> ../src/mytest.la&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;the</span> <span class="err">source</span> <span class="err">code</span> <span class="err">for</span> <span class="err">our</span> <span class="err">extensions</span> <span class="err">module&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;nodist</span> <span class="err">because</span> <span class="err">this</span> <span class="err">file</span> <span class="err">will</span> <span class="err">be</span> <span class="err">generated</span> <span class="err">by</span> <span class="err">swig&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="nv">nodist__mytest_la_SOURCES</span> <span class="o">=</span> mytest_wrap.c&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;-module</span> <span class="err">forces</span> <span class="err">libtool</span> <span class="err">to</span> <span class="err">generate</span> <span class="err">a</span> <span class="err">dynamically</span> <span class="err">loadable</span> <span class="err">module&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="nv">_mytest_la_LDFLAGS</span> <span class="o">=</span> -avoid-version -module -shared -export-dynamic&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;nodist</span> <span class="err">because</span> <span class="err">this</span> <span class="err">file</span> <span class="err">will</span> <span class="err">be</span> <span class="err">generated</span> <span class="err">by</span> <span class="err">swig&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="nv">nodist_python_PYTHON</span> <span class="o">=</span> mytest.py&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;h1&gt;this</span> <span class="err">line</span> <span class="err">assumes</span> <span class="err">that</span> <span class="err">the</span> <span class="err">swig</span> <span class="err">interface</span> <span class="err">file</span> <span class="err">mytest.i</span> <span class="err">is</span> <span class="err">located</span> <span class="err">in</span> <span class="err">the</span> <span class="err">src</span> <span class="err">subdirectory&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">&lt;p&gt;mytest_wrap.c</span><span class="o">:</span> <span class="k">$(</span><span class="nv">top_srcdir</span><span class="k">)</span>/<span class="n">src</span>/<span class="n">mytest</span>.<span class="n">i</span>
</span><span class='line'>    <span class="k">$(</span>SWIG<span class="k">)</span> -I<span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/include -includeall -o mytest_wrap.c -python <span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/src/mytest.i&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nf">&lt;p&gt;mytest.py</span><span class="o">:</span> <span class="n">mytest_wrap</span>.<span class="n">c</span>&lt;/<span class="n">p</span>&gt;
</span><span class='line'>
</span><span class='line'><span class="nf">&lt;p&gt;clean-local</span><span class="o">:</span>
</span><span class='line'>    rm -rf mytest_wrap.c mytest.py mytest.pyc&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;endif&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>When writing an autotools based project using these guidelines, you should have no problem compiling and installing your python bindings and the C-library it depends on, with the familiar commands:</p>

<pre><code>./configure
make
make install
</code></pre>

<h2>The code</h2>

<p>The full code follows: as usual it&rsquo;s a github gist so feel free to clone it and hack away at it.</p>

<p><div><script src='https://gist.github.com/6441999.js'></script>
<noscript><pre><code>#python bindings will only be built if all buildtools are available, hence the following automake conditional
if ENABLE_PYTHON
#our python extension module
pyexec_LTLIBRARIES = _mytest.la
_mytest_la_CFLAGS = $(PYTHON_CFLAGS) -I$(top_srcdir)/include $(PYTHON_CPPFLAGS)
#link to the C-library
#probably on Windows one will need to link against the python dll as well
_mytest_la_LIBADD = ../src/mytest.la
#the source code for our extensions module
#nodist because this file will be generated by swig
nodist__mytest_la_SOURCES = mytest_wrap.c
#-module forces libtool to generate a dynamically loadable module
_mytest_la_LDFLAGS = -avoid-version -module -shared -export-dynamic


#nodist because this file will be generated by swig
nodist_python_PYTHON = mytest.py

#this line assumes that the swig interface file mytest.i is located in the src subdirectory
mytest_wrap.c: $(top_srcdir)/src/mytest.i
	$(SWIG) -I${top_srcdir}/include -includeall -o mytest_wrap.c -python ${top_srcdir}/src/mytest.i
        
mytest.py: mytest_wrap.c

clean-local:
	rm -rf mytest_wrap.c mytest.py mytest.pyc
        
endif</code></pre></noscript></div>
</p>
]]></content>
  </entry>
  
</feed>
